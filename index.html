<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‘ç¥¥å£èªéŒ„éŸ³ç³»çµ±</title>
    <style>
        :root { --bg: #F0FFF0; --primary: #FFB100; --secondary: #2192FF; --danger: #EF4444; --text: #1F2937; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: var(--bg); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; min-height: -webkit-fill-available; overflow: hidden; }
        html { height: -webkit-fill-available; }
        .container { width: 92%; max-width: 400px; display: flex; flex-direction: column; padding: 12px 15px; box-sizing: border-box; background: white; border-radius: 25px; border: 4px solid var(--text); box-shadow: 0 8px 0px #D1D5DB; margin: auto; }
        .header-box { background: var(--primary); padding: 8px 0; border-radius: 12px; border: 3px solid var(--text); margin-bottom: 8px; }
        h1 { font-size: 18px; color: var(--text); margin: 0; text-align: center; white-space: nowrap; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mode-btn { background: #F3F4F6; border: 3px solid var(--text); border-radius: 10px; padding: 10px 0; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 var(--text); transition: 0.1s; text-align: center; }
        .mode-btn.active { background: var(--secondary); color: white; transform: translateY(2px); box-shadow: 0 2px 0 var(--text); }
        .mode-btn span { font-size: 11px; display: block; font-weight: normal; }
        .timer-box { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 80px; }
        #clock { font-size: 85px; font-weight: 900; color: var(--text); font-family: 'Arial', sans-serif; letter-spacing: -3px; }
        .action-area { display: flex; flex-direction: column; align-items: center; padding-bottom: 5px; }
        #recordBtn { width: 125px; height: 125px; border-radius: 50%; border: 6px solid var(--text); background: var(--danger); color: white; font-size: 24px; font-weight: 900; cursor: pointer; box-shadow: 0 8px 0 #991B1B; transition: 0.2s; }
        #recordBtn:disabled { background: #D1D5DB; box-shadow: 0 4px 0 #9CA3AF; opacity: 0.6; }
        #recordBtn.recording { animation: pulse 1s infinite; background: #FF0000; box-shadow: none; border-color: #fff; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        #status { margin-top: 8px; font-size: 15px; color: var(--secondary); font-weight: bold; text-align: center; min-height: 22px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-box"><h1>ç‘ç¥¥åœ‹å°æ¨¡æ“¬éŒ„éŸ³ ğŸ¤</h1></div>
        <div class="grid">
            <button class="mode-btn" onclick="prep(30, this, 'ä¸€ã€ç™¼éŸ³æœ—è®€')">ä¸€ã€ç™¼éŸ³æœ—è®€<span>30s</span></button>
            <button class="mode-btn" onclick="prep(60, this, 'äºŒã€çœ‹åœ–è¬›è©±')">äºŒã€çœ‹åœ–è¬›è©±<span>60s</span></button>
            <button class="mode-btn" onclick="prep(60, this, 'ä¸‰ã€çœ‹æœˆèªŒ')">ä¸‰ã€çœ‹æœˆèªŒ<span>60s</span></button>
            <button class="mode-btn" onclick="prep(60, this, 'å››ã€å£èªè¡¨é”')">å››ã€å£èªè¡¨é”<span>60s</span></button>
        </div>
        <div class="timer-box"><div id="clock">00:00</div></div>
        <div class="action-area">
            <button id="recordBtn" onclick="run()" disabled>START</button>
            <div id="status">è«‹å…ˆé¸å–æ¸¬é©—é …ç›®</div>
        </div>
    </div>

    <script>
        const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxG2kE_6UAv_mjZyLkPACmzwhy9nL0znmS6xZOkZttdzTVTJ2iYsUafZsIFFRw3O1kd/exec";
        let audioCtx, recorder, chunks = [], limit = 0, timer, cat = "";

        function makeBeep(times) {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioCtx.currentTime;
            for (let i = 0; i < times; i++) {
                const start = now + (i * 0.5);
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, start);
                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(0.5, start + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, start + 0.4);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(start); osc.stop(start + 0.5);
            }
        }

        function prep(s, btn, name) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            limit = s; cat = name;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            btn.disabled = false;
            btn.innerText = "START";
            document.getElementById('status').innerText = "å·²é¸å®šï¼š" + name.substring(2);
            draw(s);
        }

        function draw(s) {
            let m = Math.floor(s/60), sec = s%60;
            document.getElementById('clock').innerText = `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        async function run() {
            try {
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                
                recorder.onstop = async () => {
                    document.getElementById('status').innerText = "â³ æ­£åœ¨å‚³é€æª”æ¡ˆ...";
                    const blob = new Blob(chunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = async () => {
                        const base64data = reader.result.split(',')[1];
                        const formData = new URLSearchParams();
                        formData.append('data', base64data);
                        formData.append('filename', `[${cat}]_${new Date().getTime()}.wav`);
                        formData.append('mimetype', 'audio/wav');
                        try {
                            await fetch(UPLOAD_URL, { method: 'POST', body: formData, mode: 'no-cors' });
                            document.getElementById('status').innerText = "âœ… å‚³é€æˆåŠŸï¼æ¸¬é©—çµæŸã€‚";
                            alert("éŒ„éŸ³å·²æˆåŠŸå‚³é€åˆ°è€å¸«çš„é›²ç«¯è³‡æ–™å¤¾ã€‚");
                        } catch (err) {
                            document.getElementById('status').innerText = "âŒ å‚³é€å¤±æ•—ã€‚";
                        }
                    };
                };

                recorder.start();
                let left = limit;
                const btn = document.getElementById('recordBtn');
                btn.disabled = true; 
                btn.classList.add('recording');
                document.getElementById('status').innerText = "ğŸ”´ éŒ„éŸ³ä¸­...";
                
                timer = setInterval(() => {
                    left--; draw(left);
                    if (left === 10) makeBeep(1);
                    if (left <= 0) {
                        clearInterval(timer); 
                        recorder.stop();
                        stream.getTracks().forEach(track => track.stop()); 
                        btn.disabled = true; 
                        btn.classList.remove('recording');
                        btn.innerText = "æ¸¬é©—çµæŸ";
                    }
                }, 1000);
            } catch (e) { alert("è«‹æˆæ¬Šéº¥å…‹é¢¨ï¼"); }
        }
    </script>
</body>
</html>